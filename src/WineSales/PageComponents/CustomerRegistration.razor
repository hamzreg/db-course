@inject NavigationManager NavigationManager
@inject WineSales.Domain.Interactors.IUserInteractor UserInteractor
@inject WineSales.Domain.Interactors.ICustomerInteractor CustomerInteractor

<Modal @ref="customerRegistrationModal">
    <ModalContent Centered>
        <ModalHeader>
            <ModalTitle>Регистрация</ModalTitle>
            <CloseButton />
        </ModalHeader>
        <ModalBody>
        <Validations @ref="@registrationValidations" ValidateOnLoad=false>
            <Validation @ref="@loginValidation" Validator="@ValidateLogin">
                <Field>
                    <FieldLabel>Логин</FieldLabel>
                    <TextEdit @bind-Text="@loginDetails.Login" Placeholder="Введите логин...">
                        <Feedback>
                            <ValidationSuccess>Отлично!</ValidationSuccess> 
                            <ValidationError>@loginErrorMsg</ValidationError> 
                        </Feedback>
                    </TextEdit>
                </Field>
            </Validation>
            <Validation @ref="@passwordValidation" Validator="@ValidatePassword">
                <Field>
                    <FieldLabel>Пароль</FieldLabel>
                    <TextEdit @bind-Text="@loginDetails.Password" Placeholder="Введите пароль...">
                        <Feedback>
                            <ValidationSuccess>Отлично!</ValidationSuccess> 
                            <ValidationError>@passwordErrorMsg</ValidationError> 
                        </Feedback>
                    </TextEdit>
                </Field>
            </Validation>
            <Validation @ref="@nameValidation" Validator="@ValidateName">
                <Field>
                    <FieldLabel>Имя</FieldLabel>
                    <TextEdit @bind-Text="@customer.Name" Placeholder="Введите имя...">
                        <Feedback>
                            <ValidationSuccess>Отлично!</ValidationSuccess> 
                            <ValidationError>@nameErrorMsg</ValidationError> 
                        </Feedback>
                    </TextEdit>
                </Field>
            </Validation>
            <Validation @ref="@surnameValidation" Validator="@ValidateSurname">
                <Field>
                    <FieldLabel>Фамилия</FieldLabel>
                    <TextEdit @bind-Text="@customer.Surname" Placeholder="Введите фамилию...">
                        <Feedback>
                            <ValidationSuccess>Отлично!</ValidationSuccess> 
                            <ValidationError>@surnameErrorMsg</ValidationError> 
                        </Feedback>
                    </TextEdit>
                </Field>
            </Validation>
        </Validations>
        </ModalBody>
        <ModalFooter>
            <Button Color="Color.Secondary" Clicked="@HideModal">Отменить</Button>
            <Button Color="Color.Primary" Clicked="@Register">Зарегистрироваться</Button>
        </ModalFooter>
    </ModalContent>
</Modal>

@code {
    private Modal? customerRegistrationModal;

    LoginDetails loginDetails = new LoginDetails();
    Customer customer = new Customer();

    Validations? registrationValidations;

    Validation? loginValidation;
    string loginErrorMsg = "";
    bool invalidLogin = false;

    Validation? passwordValidation;
    string passwordErrorMsg = "";
    bool invalidPassword = false;

    Validation? nameValidation;
    string nameErrorMsg = "";
    bool invalidName = false;

    Validation? surnameValidation;
    string surnameErrorMsg = "";
    bool invalidSurname = false;

    public void ShowModal()
    {
        Log.Information("CustomerRegistration showed.");
        customerRegistrationModal.Show();
    }

    async Task Register()
    {
        if (await registrationValidations.ValidateAll())
        {
            try
            {
                CustomerInteractor.CreateCustomer(customer);
                Customer createdCustomer = CustomerInteractor.GetByNameSurname(customer.Name, customer.Surname);

                UserInteractor.Register(loginDetails, "customer", createdCustomer.ID);
                UserInteractor.SignIn(loginDetails);

                Log.Information("User registered customer account.");

                NavigationManager.NavigateTo(NavigationManager.Uri, true);
                await registrationValidations.ClearAll();
            }
            catch(UserException ex)
            {
                Log.Error("UserException received.");

                Customer createdCustomer = CustomerInteractor.GetByNameSurname(customer.Name, customer.Surname);

                if (createdCustomer is not null)
                {
                    CustomerInteractor.DeleteCustomer(createdCustomer);
                }

                var errorMsg = ex.Message;

                if (errorMsg == "User: This user already exists.")
                {
                    invalidLogin = true;
                    await registrationValidations.ValidateAll();
                }
                else if (errorMsg == "User: Invalid input of password.")
                {
                    invalidPassword = true;
                    await registrationValidations.ValidateAll();
                }
            }
            catch(CustomerException ex)
            {
                Log.Error("CustomerException received.");

                var errorMsg = ex.Message;

                if (errorMsg == "Customer: This customer already exists.")
                {
                    invalidName = true;
                    invalidSurname = true;

                    await registrationValidations.ValidateAll();
                }
            }
        }
    }

    void ValidateLogin(ValidatorEventArgs fact)
    {
        Console.WriteLine("ValidateLogin");

        if (invalidLogin)
        {
            loginErrorMsg = "Введенный логин уже занят.";
            fact.Status = ValidationStatus.Error;
            invalidLogin = false;
        }
        else
        {
            var login = Convert.ToString(fact.Value);

            if (string.IsNullOrEmpty(login))
            {
                loginErrorMsg = "Неверный логин.";
                fact.Status = ValidationStatus.Error;
            }
            else
            {
                fact.Status = ValidationStatus.Success;
            }
        }
    }

    void ValidatePassword(ValidatorEventArgs fact)
    {
        Console.WriteLine("ValidatePassword");

        if (invalidPassword)
        {
            passwordErrorMsg = "Пароль должен содержать минимум 8 символов.";
            fact.Status = ValidationStatus.Error;
            invalidPassword = false;
        }
        else
        {
            var password = Convert.ToString(fact.Value);

            if (string.IsNullOrEmpty(password))
            {
                passwordErrorMsg = "Неверный пароль.";
                fact.Status = ValidationStatus.Error;
            }
            else
            {
                fact.Status = ValidationStatus.Success;
            }
        }
    }

    void ValidateName(ValidatorEventArgs fact)
    {
        if (invalidName)
        {
            nameErrorMsg = "Такой пользователь уже существует.";
            fact.Status = ValidationStatus.Error;
            invalidName = false;
        }
        else
        {
            var name = Convert.ToString(fact.Value);

            if (string.IsNullOrEmpty(name))
            {
                nameErrorMsg = "Неверное имя.";
                fact.Status = ValidationStatus.Error;
            }
            else
            {
                fact.Status = ValidationStatus.Success;
            }
        }
    }

    void ValidateSurname(ValidatorEventArgs fact)
    {
        if (invalidSurname)
        {
            surnameErrorMsg = "Такой пользователь уже существует.";
            fact.Status = ValidationStatus.Error;
            invalidSurname = false;
        }
        else
        {
            var surname = Convert.ToString(fact.Value);

            if (string.IsNullOrEmpty(surname))
            {
                surnameErrorMsg = "Неверная фамилия.";
                fact.Status = ValidationStatus.Error;
            }
            else
            {
                fact.Status = ValidationStatus.Success;
            }
        }
    }

    private Task HideModal()
    {
        Log.Information("Button <HideModal> clicked.");
        return customerRegistrationModal.Hide();
    }
}
